---
# Setup Pi-hole DNS Server for Home Network
# Run: ansible-playbook -i inventory/hosts.yml playbooks/setup-pihole.yml

- name: Setup Pi-hole DNS Server
  hosts: pihole
  become: true

  vars:
    # Pi-hole configuration
    pihole_interface: "eth0"

  tasks:
    # =========================================================================
    # System Setup
    # =========================================================================
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install prerequisites
      apt:
        name:
          - curl
          - git
          - vim
        state: present

    # =========================================================================
    # Pi-hole Installation
    # =========================================================================
    - name: Create Pi-hole config directory
      file:
        path: /etc/pihole
        state: directory
        mode: '0755'

    - name: Create Pi-hole unattended install config (for v6 migration)
      copy:
        dest: /etc/pihole/setupVars.conf
        content: |
          PIHOLE_INTERFACE={{ pihole_interface }}
          QUERY_LOGGING=true
          INSTALL_WEB_SERVER=true
          INSTALL_WEB_INTERFACE=true
          LIGHTTPD_ENABLED=true
          CACHE_SIZE=10000
          DNS_FQDN_REQUIRED=true
          DNS_BOGUS_PRIV=true
          DNSMASQ_LISTENING=local
          PIHOLE_DNS_1={{ upstream_dns_1 }}
          PIHOLE_DNS_2={{ upstream_dns_2 }}
          DNSSEC=false
          REV_SERVER=false
          BLOCKING_ENABLED=true
        mode: '0644'

    - name: Check if Pi-hole is already installed
      stat:
        path: /usr/local/bin/pihole
      register: pihole_installed

    - name: Download and install Pi-hole (unattended)
      shell: curl -sSL https://install.pi-hole.net | bash /dev/stdin --unattended
      args:
        creates: /usr/local/bin/pihole
      when: not pihole_installed.stat.exists

    # =========================================================================
    # Pi-hole v6 Configuration
    # =========================================================================
    - name: Build DNS hosts list for Pi-hole v6 TOML
      set_fact:
        pihole_hosts_list: "{{ local_dns_entries | map(attribute='ip') | zip(local_dns_entries | map(attribute='name')) | map('join', ' ') | map('regex_replace', '^(.*)$', '\"\\1\"') | list | join(', ') }}"

    - name: Configure DNS hosts in Pi-hole v6 TOML (first occurrence)
      lineinfile:
        path: /etc/pihole/pihole.toml
        regexp: '^(\s*)hosts = \['
        line: '  hosts = [{{ pihole_hosts_list }}]'
      notify: Reload Pi-hole DNS

    - name: Enable dnsmasq.d includes in Pi-hole v6
      lineinfile:
        path: /etc/pihole/pihole.toml
        regexp: '^(\s*)etc_dnsmasq_d = false'
        line: '  etc_dnsmasq_d = true'
      notify: Reload Pi-hole DNS

    # =========================================================================
    # Wildcard DNS for K3s Traefik Ingress
    # =========================================================================
    - name: Ensure dnsmasq.d directory exists
      file:
        path: /etc/dnsmasq.d
        state: directory
        mode: '0755'

    - name: Create wildcard DNS for K3s services
      copy:
        dest: /etc/dnsmasq.d/05-home-wildcard.conf
        content: |
          # Wildcard DNS for K3s Traefik Ingress
          # All *.{{ base_domain }} subdomains route to K3s node
          address=/{{ base_domain }}/{{ k3s_ip }}
        mode: '0644'
      notify: Reload Pi-hole DNS

    # =========================================================================
    # Set Admin Password
    # =========================================================================
    - name: Set Pi-hole admin password
      shell: pihole setpassword '{{ pihole_admin_password }}'
      no_log: true
      changed_when: true

    # =========================================================================
    # Update Gravity (blocklists)
    # =========================================================================
    - name: Update Pi-hole gravity (ad lists)
      shell: pihole -g
      async: 300
      poll: 10
      when: not pihole_installed.stat.exists

    # =========================================================================
    # Verify Installation
    # =========================================================================
    - name: Get Pi-hole status
      shell: pihole status
      register: pihole_status
      changed_when: false

    - name: Show Pi-hole status
      debug:
        msg: "{{ pihole_status.stdout_lines }}"

    - name: Test DNS resolution
      shell: "dig @127.0.0.1 {{ item.name }} +short"
      loop: "{{ local_dns_entries[:3] }}"
      register: dns_test
      changed_when: false

    - name: Show DNS test results
      debug:
        msg: "{{ item.item.name }} -> {{ item.stdout }}"
      loop: "{{ dns_test.results }}"

  handlers:
    - name: Reload Pi-hole DNS
      shell: pihole reloaddns
