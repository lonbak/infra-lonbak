---
# Setup K3s Single-Node Cluster in LXC Container
# Run: ansible-playbook -i inventory/hosts.yml playbooks/setup-k3s.yml
#
# Prerequisites (run setup-proxmox.yml first):
# - Kernel modules loaded on Proxmox host: br_netfilter, overlay
# - Kernel parameters set on host: vm.overcommit_memory=1, kernel.panic=10, kernel.panic_on_oops=1
# - LXC container must be privileged with nesting enabled

- name: Setup K3s Single-Node Cluster (LXC)
  hosts: k3s
  become: true

  tasks:
    # =========================================================================
    # System Setup
    # =========================================================================
    - name: Update apt cache and upgrade packages
      apt:
        update_cache: yes
        upgrade: dist
        cache_valid_time: 3600

    - name: Install base packages
      apt:
        name:
          - curl
          - wget
          - git
          - vim
          - htop
          - jq
          - unzip
          - apt-transport-https
          - ca-certificates
          - gnupg
          - lsb-release
        state: present

    - name: Set timezone
      timezone:
        name: UTC

    # =========================================================================
    # LXC Workarounds for K3s
    # =========================================================================
    - name: Create /dev/kmsg symlink (required for kubelet in LXC)
      file:
        src: /dev/console
        dest: /dev/kmsg
        state: link
        force: yes

    - name: Create systemd service to persist /dev/kmsg symlink on boot
      copy:
        dest: /etc/systemd/system/create-kmsg.service
        content: |
          [Unit]
          Description=Create /dev/kmsg symlink for K3s
          Before=k3s.service

          [Service]
          Type=oneshot
          ExecStart=/bin/ln -sf /dev/console /dev/kmsg
          RemainAfterExit=yes

          [Install]
          WantedBy=multi-user.target
        mode: '0644'

    - name: Enable create-kmsg service
      systemd:
        name: create-kmsg
        enabled: yes
        daemon_reload: yes

    # =========================================================================
    # K3s Installation
    # =========================================================================
    - name: Check if K3s is already installed
      stat:
        path: /usr/local/bin/k3s
      register: k3s_installed

    - name: Install K3s
      shell: |
        curl -sfL https://get.k3s.io | INSTALL_K3S_VERSION="{{ k3s_version }}" sh -s - server \
          --disable traefik \
          --write-kubeconfig-mode 644 \
          --node-name k3s-node \
          --kubelet-arg=protect-kernel-defaults=true \
          --cluster-cidr 10.42.0.0/16 \
          --service-cidr 10.43.0.0/16
      when: not k3s_installed.stat.exists

    - name: Remove modprobe from K3s service (not needed in LXC, modules on host)
      lineinfile:
        path: /etc/systemd/system/k3s.service
        regexp: '^ExecStartPre=.*modprobe'
        state: absent
      notify: Reload systemd

    - name: Ensure K3s service is enabled and started
      systemd:
        name: k3s
        enabled: yes
        state: started
        daemon_reload: yes

    - name: Wait for K3s to be ready
      shell: k3s kubectl get nodes --no-headers | grep -q "Ready"
      register: k3s_ready
      retries: 30
      delay: 10
      until: k3s_ready.rc == 0

    # =========================================================================
    # Setup kubectl alias for root
    # =========================================================================
    - name: Add kubectl aliases to root bashrc
      lineinfile:
        path: /root/.bashrc
        line: "{{ item }}"
        state: present
      loop:
        - 'alias k="kubectl"'
        - 'alias kubectl="k3s kubectl"'
        - 'alias kgp="k3s kubectl get pods -A"'
        - 'alias kgs="k3s kubectl get svc -A"'
        - 'alias kgi="k3s kubectl get ingress -A"'

    # =========================================================================
    # Install Helm
    # =========================================================================
    - name: Check if Helm is installed
      stat:
        path: /usr/local/bin/helm
      register: helm_installed

    - name: Install Helm
      shell: |
        curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
      when: not helm_installed.stat.exists

    # =========================================================================
    # Create namespaces for services
    # =========================================================================
    - name: Create namespaces
      shell: k3s kubectl create namespace {{ item }} --dry-run=client -o yaml | k3s kubectl apply -f -
      loop:
        - traefik
        - omada
        - registry
        - uptime-kuma
        - apps

    # =========================================================================
    # Install Traefik via Helm
    # =========================================================================
    - name: Add Traefik Helm repository
      shell: helm repo add traefik https://traefik.github.io/charts && helm repo update
      changed_when: false

    - name: Check if Traefik is installed
      shell: helm list -n traefik | grep -q traefik
      register: traefik_installed
      failed_when: false
      changed_when: false

    - name: Copy Traefik values file
      copy:
        src: ../../kubernetes/traefik/values.yaml
        dest: /tmp/traefik-values.yaml
        mode: '0644'
      when: traefik_installed.rc != 0

    - name: Install Traefik
      shell: |
        helm upgrade --install traefik traefik/traefik \
          -n traefik \
          -f /tmp/traefik-values.yaml
      when: traefik_installed.rc != 0

    # =========================================================================
    # System Tuning for K3s
    # =========================================================================
    - name: Increase file watchers for containers
      sysctl:
        name: fs.inotify.max_user_watches
        value: '524288'
        state: present
        reload: yes

    - name: Increase file descriptors
      sysctl:
        name: fs.file-max
        value: '2097152'
        state: present
        reload: yes

    # =========================================================================
    # Verify Installation
    # =========================================================================
    - name: Get cluster info
      shell: k3s kubectl cluster-info
      register: cluster_info
      changed_when: false

    - name: Show cluster info
      debug:
        msg: "{{ cluster_info.stdout_lines }}"

    - name: Get nodes
      shell: k3s kubectl get nodes -o wide
      register: nodes_info
      changed_when: false

    - name: Show nodes
      debug:
        msg: "{{ nodes_info.stdout_lines }}"

    - name: Get all pods
      shell: k3s kubectl get pods -A
      register: pods_info
      changed_when: false

    - name: Show pods
      debug:
        msg: "{{ pods_info.stdout_lines }}"

  handlers:
    - name: Reload systemd
      systemd:
        daemon_reload: yes
